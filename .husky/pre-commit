#!/bin/bash

# Pre-commit hook
# ì»¤ë°‹ ì „ì— ì‹¤í–‰ë˜ëŠ” ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# Nx ì›Œí¬ìŠ¤í˜ì´ìŠ¤ í™˜ê²½ì—ì„œì˜ pre-commit ê²€ì¦
# 1. ë¦°íŠ¸ ê²€ì‚¬
# 2. íƒ€ì… ì²´í¬
# 3. í¬ë§·íŒ… ê²€ì‚¬

# ë³€ê²½ëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$staged_files" ]; then
    echo "ğŸ“ JavaScript/TypeScript íŒŒì¼ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
    echo "âœ… Pre-commit ê²€ì¦ ì™„ë£Œ!"
    exit 0
fi

echo "ğŸ“ ê²€ì¦í•  íŒŒì¼ë“¤:"
echo "$staged_files" | sed 's/^/   - /'

# 1. ESLint ê²€ì‚¬
echo ""
echo "ğŸ” ESLint ê²€ì‚¬ ì¤‘..."
if command -v npx >/dev/null 2>&1; then
    if ! echo "$staged_files" | xargs npx eslint --max-warnings=0; then
        echo ""
        echo "âŒ ESLint ê²€ì‚¬ ì‹¤íŒ¨!"
        echo "ğŸ’¡ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¬¸ì œë¥¼ ìˆ˜ì •í•´ë³´ì„¸ìš”:"
        echo "   npx eslint --fix <íŒŒì¼ëª…>"
        exit 1
    fi
    echo "âœ… ESLint ê²€ì‚¬ í†µê³¼!"
else
    echo "âš ï¸  npxë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ESLint ê²€ì‚¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

# 2. TypeScript íƒ€ì… ì²´í¬ (tsc)
echo ""
echo "ğŸ” TypeScript íƒ€ì… ì²´í¬ ì¤‘..."
if command -v npx >/dev/null 2>&1; then
    if ! npx tsc --noEmit; then
        echo ""
        echo "âŒ TypeScript íƒ€ì… ì²´í¬ ì‹¤íŒ¨!"
        echo "ğŸ’¡ íƒ€ì… ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì»¤ë°‹í•´ì£¼ì„¸ìš”."
        exit 1
    fi
    echo "âœ… TypeScript íƒ€ì… ì²´í¬ í†µê³¼!"
else
    echo "âš ï¸  npxë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ TypeScript ê²€ì‚¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

# 3. Prettier í¬ë§·íŒ… ì²´í¬
echo ""
echo "ğŸ” Prettier í¬ë§·íŒ… ì²´í¬ ì¤‘..."
if command -v npx >/dev/null 2>&1; then
    if ! echo "$staged_files" | xargs npx prettier --check; then
        echo ""
        echo "âŒ í¬ë§·íŒ… ë¬¸ì œ ë°œê²¬!"
        echo "ğŸ’¡ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìë™ í¬ë§·íŒ…í•˜ì„¸ìš”:"
        echo "   npx prettier --write <íŒŒì¼ëª…>"
        echo "   ë˜ëŠ”"
        echo "   npx prettier --write ."
        exit 1
    fi
    echo "âœ… Prettier í¬ë§·íŒ… ì²´í¬ í†µê³¼!"
else
    echo "âš ï¸  npxë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ Prettier ê²€ì‚¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

# 4. ê¸ˆì§€ëœ ì½”ë“œ íŒ¨í„´ ì²´í¬
echo ""
echo "ğŸ” ê¸ˆì§€ëœ ì½”ë“œ íŒ¨í„´ ì²´í¬ ì¤‘..."

# console.log ì²´í¬ (ê°œë°œìš©)
if echo "$staged_files" | xargs grep -n "console\.log" --color=never 2>/dev/null; then
    echo ""
    echo "âš ï¸  console.logê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo "ğŸ’¡ í”„ë¡œë•ì…˜ ì½”ë“œì—ì„œ console.logë¥¼ ì œê±°í•´ì£¼ì„¸ìš”."
    echo "   ê°œë°œìš©ì´ë¼ë©´ ì´ ê²½ê³ ë¥¼ ë¬´ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
fi

# TODO/FIXME ì²´í¬
todo_count=$(echo "$staged_files" | xargs grep -n -E "(TODO|FIXME|XXX)" --color=never 2>/dev/null | wc -l || echo "0")
if [ "$todo_count" -gt 0 ]; then
    echo ""
    echo "ğŸ“ TODO/FIXMEê°€ $todo_countê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo "ğŸ’¡ ê°€ëŠ¥í•˜ë©´ ì»¤ë°‹ ì „ì— ì²˜ë¦¬í•´ì£¼ì„¸ìš”."
fi

echo ""
echo "ğŸ‰ ëª¨ë“  pre-commit ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"

exit 0
